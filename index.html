<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Inventario Coil Pro + QR</title>
    <script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    
    <style>
        :root {
            --primary: #2563eb; --bg: #f3f4f6; --card: #ffffff;
            --text: #1f2937; --danger: #ef4444; --success: #218838;
        }
        body { font-family: -apple-system, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 10px; display: flex; flex-direction: column; align-items: center; }
        .app-card { background: white; width: 100%; max-width: 500px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); padding: 15px; box-sizing: border-box; }
        
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .page { display: none; width: 100%; }
        .page.active { display: block; }

        .field { margin-bottom: 12px; position: relative; }
        label { display: block; font-size: 0.7rem; font-weight: 800; color: #6b7280; margin-bottom: 4px; text-transform: uppercase; }
        select, input { width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 10px; font-size: 16px; box-sizing: border-box; background: white; }

        .btn-main { width: 100%; background: var(--primary); color: white; border: none; padding: 14px; border-radius: 10px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        .btn-config { background: none; border: none; font-size: 1.5rem; cursor: pointer; }
        
        /* Bot贸n QR */
        .btn-qr { position: absolute; right: 5px; top: 24px; background: #333; color: white; border: none; padding: 8px 12px; border-radius: 8px; cursor: pointer; z-index: 5; }
        #reader { width: 100%; border-radius: 10px; overflow: hidden; margin-bottom: 15px; display: none; }

        .inv-item { background: var(--card); border-radius: 12px; margin-bottom: 8px; border: 1px solid #e5e7eb; overflow: hidden; }
        .inv-header { padding: 15px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        .inv-details { max-height: 0; background: #f9fafb; overflow: hidden; transition: max-height 0.3s ease-out; }
        .inv-item.open .inv-details { max-height: 2000px; border-top: 1px solid #eee; }

        .detail-row { padding: 12px 15px; border-bottom: 1px solid #eee; font-size: 0.85rem; display: flex; flex-direction: column; gap: 4px; position: relative; padding-right: 50px; }
        .btn-delete-row { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: #fee2e2; color: #dc2626; border: none; width: 32px; height: 32px; border-radius: 50%; font-weight: bold; }
        .badge-total { color: white; padding: 4px 10px; border-radius: 12px; font-weight: bold; font-size: 0.9rem; }
    </style>
</head>
<body>

<div class="app-card">
    <div id="page-main" class="page active">
        <header>
            <h2 style="margin:0; font-size: 1.1rem;"> Inventario Coil</h2>
            <button class="btn-config" onclick="showPage('page-config')">锔</button>
        </header>

        <div id="reader"></div>

        <div class="field">
            <label>Calibre (Ancho)</label>
            <select id="main-calibre" onchange="saveLastSelection(); updatePreview();"></select>
        </div>
        <div class="field">
            <label>Familia</label>
            <select id="main-familia" onchange="saveLastSelection(); updatePreview();"></select>
        </div>
        
        <div id="preview" style="background:#eef2ff; padding:10px; border-radius:8px; margin-bottom:10px; font-family:monospace; font-size:0.8rem; text-align:center; font-weight:bold; color: var(--primary);"> - </div>
        
        <div class="field">
            <label>Cantidad (Lbs)</label>
            <input type="number" id="main-qty" placeholder="0.00" inputmode="decimal">
            <button class="btn-qr" onclick="toggleScanner()"> QR</button>
        </div>

        <button class="btn-main" onclick="agregar()">REGISTRAR MATERIAL</button>
        <hr style="margin:20px 0; border:0; border-top:1px solid #eee;">
        <div id="contenedorPrincipal"></div>
    </div>

    <div id="page-config" class="page">
        <header>
            <button class="btn-config" onclick="showPage('page-main')">猬锔</button>
            <h2 style="margin:0; font-size: 1.1rem;">Ajustes</h2>
        </header>
        <button class="btn-main" onclick="descargarExcel()" style="background:var(--success)"> EXPORTAR EXCEL</button>
    </div>
</div>

<script>
    let config = JSON.parse(localStorage.getItem('coil_conf_v3')) || { calibres: ['13.400'], familias: [{n:'B23Q090', t:0.0091}] };
    let inventory = JSON.parse(localStorage.getItem('coil_data_v3')) || [];
    let lastSelection = JSON.parse(localStorage.getItem('coil_last_sel')) || { calibre: '', familia: '' };
    let html5QrCode;

    // --- LGICA DEL ESCNER ---
    function toggleScanner() {
        const readerDiv = document.getElementById('reader');
        if (readerDiv.style.display === 'block') {
            stopScanner();
        } else {
            readerDiv.style.display = 'block';
            html5QrCode = new Html5Qrcode("reader");
            html5QrCode.start(
                { facingMode: "environment" }, 
                { fps: 10, qrbox: { width: 250, height: 250 } },
                onScanSuccess
            ).catch(err => alert("Error de c谩mara: " + err));
        }
    }

    function onScanSuccess(decodedText) {
        // Ejemplo: 13.4009999B23P090
        try {
            const acero = decodedText.substring(0, 6);      // "13.400"
            const cantidad = decodedText.substring(6, 10);  // "9999"
            const familia = decodedText.substring(10);      // "B23P090"

            // 1. Verificar si el calibre existe, si no, agregarlo
            if(!config.calibres.includes(acero)) {
                config.calibres.push(acero);
                saveConfig();
            }
            document.getElementById('main-calibre').value = acero;

            // 2. Verificar si la familia existe (si no existe, avisar o usar una por defecto)
            const famExistente = config.familias.find(f => f.n === familia);
            if(famExistente) {
                document.getElementById('main-familia').value = familia;
            } else {
                alert(`Familia ${familia} no encontrada en Ajustes. Por favor agr茅gala.`);
            }

            // 3. Asignar cantidad
            document.getElementById('main-qty').value = parseFloat(cantidad);

            saveLastSelection();
            updatePreview();
            stopScanner();
            
            // Feedback visual
            document.getElementById('main-qty').style.backgroundColor = "#dcfce7";
            setTimeout(() => document.getElementById('main-qty').style.backgroundColor = "white", 1000);

        } catch (e) {
            alert("Error al procesar el c贸digo: Formato inv谩lido");
        }
    }

    function stopScanner() {
        if (html5QrCode) {
            html5QrCode.stop().then(() => {
                document.getElementById('reader').style.display = 'none';
            });
        }
    }

    // --- FUNCIONES DE PERSISTENCIA Y RENDER (Basadas en tu versi贸n anterior) ---

    function saveLastSelection() {
        lastSelection = {
            calibre: document.getElementById('main-calibre').value,
            familia: document.getElementById('main-familia').value
        };
        localStorage.setItem('coil_last_sel', JSON.stringify(lastSelection));
    }

    function updatePreview() {
        const c = document.getElementById('main-calibre').value;
        const fName = document.getElementById('main-familia').value;
        const fObj = config.familias.find(fam => fam.n === fName);
        document.getElementById('preview').innerText = (fObj && c) ? `${fObj.t} x ${c} x COIL` : '-';
    }

    function agregar() {
        const c = document.getElementById('main-calibre').value;
        const f = document.getElementById('main-familia').value;
        const q = parseFloat(document.getElementById('main-qty').value);
        const famObj = config.familias.find(fam => fam.n === f);
        if(!c || !f || isNaN(q)) return alert("Datos incompletos");

        inventory.unshift({ 
            id: Date.now(), calibre: c, familia: f, 
            thickness: famObj.t, tag: `${famObj.t} x ${c} x COIL`, qty: q 
        });
        localStorage.setItem('coil_data_v3', JSON.stringify(inventory));
        document.getElementById('main-qty').value = "";
        render();
    }

    function render() {
        const calibresOrdenados = [...config.calibres].sort((a, b) => parseFloat(b) - parseFloat(a));
        
        const selCal = document.getElementById('main-calibre');
        selCal.innerHTML = calibresOrdenados.map(c => `<option value="${c}">${c}</option>`).join('');
        if(lastSelection.calibre) selCal.value = lastSelection.calibre;

        const selFam = document.getElementById('main-familia');
        selFam.innerHTML = config.familias.map(f => `<option value="${f.n}">${f.n}</option>`).join('');
        if(lastSelection.familia) selFam.value = lastSelection.familia;

        updatePreview();
        // ... (resto de l贸gica de renderizado de lista similar a la v3)
    }

    function showPage(id) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        if(id === 'page-main') render();
    }

    window.onload = render;
</script>
</body>
</html>
