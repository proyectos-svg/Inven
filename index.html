<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Inventario Coil Pro</title>
    <script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.js"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <style>
        :root { --primary: #2563eb; --bg: #f3f4f6; --card: #ffffff; --text: #1f2937; --danger: #ef4444; --success: #218838; --scan: #059669; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 10px; display: flex; flex-direction: column; align-items: center; }
        .app-card { background: white; width: 100%; max-width: 500px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); padding: 15px; box-sizing: border-box; }
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .page { display: none; width: 100%; }
        .page.active { display: block; }
        .field { margin-bottom: 12px; }
        label { display: block; font-size: 0.7rem; font-weight: 800; color: #6b7280; margin-bottom: 4px; text-transform: uppercase; }
        select, input { width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 10px; font-size: 16px; box-sizing: border-box; background: white; }
        .btn-main { width: 100%; background: var(--primary); color: white; border: none; padding: 14px; border-radius: 10px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        .btn-scan { background: var(--scan); margin-bottom: 10px; }
        .btn-stop { background: var(--danger); font-size: 0.8rem; padding: 8px; margin-bottom: 10px; }
        #reader { width: 100%; border-radius: 12px; overflow: hidden; border: 2px solid var(--scan); margin-bottom: 15px; display: none; background: #000; }
        .config-section { background:#f8fafc; padding:15px; border-radius:10px; margin-bottom:15px; border: 1px solid #e2e8f0; }
        .list-item-conf { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #e2e8f0; }
        .btn-delete-small { background: #fee2e2; color: #dc2626; border: none; padding: 5px 10px; border-radius: 6px; font-weight: bold; }
        .inv-item { background: var(--card); border-radius: 12px; margin-bottom: 8px; border: 1px solid #e5e7eb; overflow: hidden; }
        .inv-header { padding: 15px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        .inv-details { max-height: 0; background: #f9fafb; overflow: hidden; transition: max-height 0.3s ease-out; }
        .inv-item.open .inv-details { max-height: 2000px; border-top: 1px solid #eee; }
        .detail-row { padding: 12px 15px; border-bottom: 1px solid #eee; font-size: 0.85rem; position: relative; }
    </style>
</head>
<body>
<div class="app-card">
    <div id="page-main" class="page active">
        <header><h2>üì¶ Coil Inventario</h2><button onclick="showPage('page-config')" style="background:none; border:none; font-size:1.5rem;">‚öôÔ∏è</button></header>
        <button id="btn-open" class="btn-main btn-scan" onclick="startScanner()">üì∑ ESCANEAR QR</button>
        <button id="btn-close" class="btn-main btn-stop" onclick="stopScanner()" style="display:none;">‚úï CERRAR C√ÅMARA</button>
        <div id="reader"></div>
        <div class="field"><label>Calibre</label><select id="main-calibre" onchange="updatePreview()"></select></div>
        <div class="field"><label>Familia</label><select id="main-familia" onchange="updatePreview()"></select></div>
        <div id="preview" style="background:#eef2ff; padding:10px; border-radius:8px; margin-bottom:10px; font-family:monospace; font-size:0.8rem; text-align:center; font-weight:bold; color: var(--primary);"> - </div>
        <div class="field"><label>Cantidad (Lbs)</label><input type="number" id="main-qty" placeholder="0.00" inputmode="decimal"></div>
        <button class="btn-main" onclick="agregar()">REGISTRAR</button>
        <div id="contenedorPrincipal" style="margin-top:20px;"></div>
    </div>

    <div id="page-config" class="page">
        <header><button onclick="showPage('page-main')">‚¨ÖÔ∏è Volver</button><h2>Ajustes</h2></header>
        <div class="config-section">
            <label>Nuevo Calibre</label>
            <div style="display:flex; gap:5px;"><input type="text" id="new-cal" placeholder="13.400"><button onclick="addCalibre()" style="background:var(--primary); color:white; border:none; padding:10px; border-radius:8px;">+</button></div>
            <div id="list-calibres"></div>
        </div>
        <div class="config-section">
            <label>Nueva Familia</label>
            <input type="text" id="new-fam-name" placeholder="Nombre" style="margin-bottom:5px;">
            <input type="number" id="new-fam-thick" step="0.0001" placeholder="Grosor (0.0091)">
            <button class="btn-main" onclick="addFamilia()">GUARDAR FAMILIA</button>
            <div id="list-familias"></div>
        </div>
        <button class="btn-main" onclick="descargarExcel()" style="background:var(--success)">üìä EXPORTAR EXCEL</button>
    </div>
</div>

<script>
    // Recuperar datos con nombres de llaves originales para no perder nada
    let config = JSON.parse(localStorage.getItem('coil_conf_v3')) || { calibres: [], familias: [] };
    let inventory = JSON.parse(localStorage.getItem('coil_data_v3')) || [];
    let html5QrCode;

    function showPage(id) {
        if (html5QrCode) stopScanner();
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        render();
    }

    async function startScanner() {
        const readerDiv = document.getElementById('reader');
        document.getElementById('btn-open').style.display = 'none';
        document.getElementById('btn-close').style.display = 'block';
        readerDiv.style.display = 'block';
        html5QrCode = new Html5Qrcode("reader");
        try {
            await html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, onScanSuccess);
        } catch (err) { alert("Error c√°mara: " + err); stopScanner(); }
    }

    async function stopScanner() {
        if (html5QrCode) { try { await html5QrCode.stop(); await html5QrCode.clear(); } catch(e){} }
        document.getElementById('reader').style.display = 'none';
        document.getElementById('btn-open').style.display = 'block';
        document.getElementById('btn-close').style.display = 'none';
    }

    function onScanSuccess(decodedText) {
        const t = decodedText.trim().toUpperCase();
        
        // CORRECCI√ìN: Ahora aceptamos c√≥digos desde 12 caracteres
        if (t.length < 12) {
            alert("C√≥digo demasiado corto: " + t);
            return;
        }

        // Extracci√≥n (mantenemos las posiciones 0-7, 7-11, 11-final)
        const cal = t.substring(0, 7).trim();
        const qty = parseFloat(t.substring(7, 11));
        const fam = t.substring(11).trim(); // Toma desde la 11 hasta el final aunque sea corto

        const famOk = config.familias.find(f => f.n === fam);
        const calOk = config.calibres.includes(cal);

        if (famOk && calOk) {
            document.getElementById('main-calibre').value = cal;
            document.getElementById('main-familia').value = fam;
            document.getElementById('main-qty').value = qty;
            updatePreview();
            stopScanner();
            if (window.navigator.vibrate) window.navigator.vibrate(100);
        } else {
            // Este mensaje ayuda a saber qu√© est√° fallando
            alert(`QR detectado: \nCalibre: ${cal} (${calOk?'OK':'Falta en ajustes'})\nCant: ${qty}\nFamilia: ${fam} (${famOk?'OK':'Falta en ajustes'})`);
        }
    }

    // AJUSTES
    function addCalibre() {
        const v = document.getElementById('new-cal').value.trim();
        if(v && !config.calibres.includes(v)) { config.calibres.push(v); save(); }
    }
    function addFamilia() {
        const n = document.getElementById('new-fam-name').value.trim().toUpperCase();
        const t = parseFloat(document.getElementById('new-fam-thick').value);
        if(n && !isNaN(t)) { config.familias.push({n, t}); save(); }
    }
    function save() { 
        localStorage.setItem('coil_conf_v3', JSON.stringify(config)); 
        render(); 
    }
    function removeCal(i) { config.calibres.splice(i,1); save(); }
    function removeFam(i) { config.familias.splice(i,1); save(); }

    // INVENTARIO
    function updatePreview() {
        const c = document.getElementById('main-calibre').value;
        const f = config.familias.find(fam => fam.n === document.getElementById('main-familia').value);
        document.getElementById('preview').innerText = (f && c) ? `${f.t} x ${c} x COIL` : '-';
    }

    function agregar() {
        const c = document.getElementById('main-calibre').value;
        const f = document.getElementById('main-familia').value;
        const q = parseFloat(document.getElementById('main-qty').value);
        if(!c || !f || isNaN(q)) return alert("Faltan datos");
        const fObj = config.familias.find(fam => fam.n === f);
        inventory.unshift({ id: Date.now(), calibre: c, familia: f, tag: `${fObj.t} x ${c} x COIL`, qty: q });
        localStorage.setItem('coil_data_v3', JSON.stringify(inventory));
        render();
    }

    function render() {
        document.getElementById('main-calibre').innerHTML = config.calibres.map(c => `<option value="${c}">${c}</option>`).join('');
        document.getElementById('main-familia').innerHTML = config.familias.map(f => `<option value="${f.n}">${f.n}</option>`).join('');
        
        document.getElementById('list-calibres').innerHTML = config.calibres.map((c, i) => `<div class="list-item-conf">${c} <button class="btn-delete-small" onclick="removeCal(${i})">‚úï</button></div>`).join('');
        document.getElementById('list-familias').innerHTML = config.familias.map((f, i) => `<div class="list-item-conf">${f.n} <button class="btn-delete-small" onclick="removeFam(${i})">‚úï</button></div>`).join('');

        const container = document.getElementById('contenedorPrincipal');
        container.innerHTML = "";
        const grupos = inventory.reduce((acc, r) => {
            if (!acc[r.calibre]) acc[r.calibre] = { p: 0, items: [] };
            acc[r.calibre].p += r.qty; acc[r.calibre].items.push(r);
            return acc;
        }, {});

        Object.keys(grupos).sort((a,b)=>b-a).forEach(cal => {
            const safeId = "group-" + cal.replace(/\./g, '-');
            const div = document.createElement("div");
            div.className = "inv-item";
            div.id = safeId;
            div.innerHTML = `<div class="inv-header" onclick="document.getElementById('${safeId}').classList.toggle('open')"><b>Ancho: ${cal}</b> <span>${grupos[cal].p.toFixed(2)} lbs</span></div>
            <div class="inv-details">${grupos[cal].items.map(r => `<div class="detail-row">${r.familia}: ${r.qty} lbs</div>`).join('')}</div>`;
            container.appendChild(div);
        });
    }

    function descargarExcel() {
        const ws = XLSX.utils.json_to_sheet(inventory);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Inventario");
        XLSX.writeFile(wb, "Reporte_Coil.xlsx");
    }

    window.onload = render;
</script>
</body>
</html>
